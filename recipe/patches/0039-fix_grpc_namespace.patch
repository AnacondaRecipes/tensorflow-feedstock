From 65ad86778b848f96e8b219fc8e563887e2f1e7cd Mon Sep 17 00:00:00 2001
From: Eric Lundby <Eric.Lundby@gmail.com>
Date: Mon, 15 Sep 2025 14:19:01 -0600
Subject: [PATCH 1/6] fix_grpc_namespace

---
 tensorflow/core/data/service/server_lib.h      |  2 +-
 tensorflow/core/debug/debug_io_utils.cc        |  2 +-
 tensorflow/core/debug/debug_io_utils.h         |  2 +-
 .../rpc/eager/grpc_eager_service_impl.cc       |  8 ++++----
 .../rpc/eager/grpc_eager_service_impl.h        | 18 +++++++++---------
 .../distributed_runtime/rpc/grpc_server_lib.h  |  2 +-
 .../core/profiler/rpc/profiler_service_impl.h  |  2 +-
 .../experimental/rpc/kernels/rpc_ops.cc        |  2 +-
 tensorflow/workspace0.bzl                      |  4 ++--
 .../systemlibs/grpc.bazel.cc_grpc_library.bzl  |  4 ++--
 .../grpc_coordination_service_impl.cc          |  4 ++--
 .../grpc_coordination_service_impl.h           |  8 ++++----
 .../tsl/profiler/rpc/client/profiler_client.cc | 14 +++++++-------
 .../tsl/profiler/rpc/client/profiler_client.h  |  2 +-
 .../xla/xla/tsl/profiler/rpc/profiler_server.h |  2 +-
 .../tsl/profiler/rpc/profiler_service_impl.cc  |  4 ++--
 .../tsl/profiler/rpc/profiler_service_impl.h   |  2 +-
 17 files changed, 41 insertions(+), 41 deletions(-)

diff --git a/tensorflow/core/data/service/server_lib.h b/tensorflow/core/data/service/server_lib.h
index 56a8f8d9..faed2dce 100644
--- a/tensorflow/core/data/service/server_lib.h
+++ b/tensorflow/core/data/service/server_lib.h
@@ -85,7 +85,7 @@ class GrpcDataServerBase {
 
   std::unique_ptr<::grpc::Server> server_;
   // TensorFlow profiler service implementation.
-  std::unique_ptr<grpc::ProfilerService::Service> profiler_service_ = nullptr;
+  std::unique_ptr<ProfilerService::Service> profiler_service_ = nullptr;
   std::vector<std::unique_ptr<::grpc::ServerBuilderOption>> server_options_;
 };
 
diff --git a/tensorflow/core/debug/debug_io_utils.cc b/tensorflow/core/debug/debug_io_utils.cc
index f5f6e9a8..86438d26 100644
--- a/tensorflow/core/debug/debug_io_utils.cc
+++ b/tensorflow/core/debug/debug_io_utils.cc
@@ -780,7 +780,7 @@ absl::Status DebugGrpcChannel::Connect(const int64_t timeout_micros) {
         "Failed to connect to gRPC channel at ", server_stream_addr_,
         " within a timeout of ", timeout_micros / 1e6, " s.");
   }
-  stub_ = grpc::EventListener::NewStub(channel_);
+  stub_ = EventListener::NewStub(channel_);
   reader_writer_ = stub_->SendEvents(&ctx_);
 
   return absl::OkStatus();
diff --git a/tensorflow/core/debug/debug_io_utils.h b/tensorflow/core/debug/debug_io_utils.h
index 95864c71..243fecfa 100644
--- a/tensorflow/core/debug/debug_io_utils.h
+++ b/tensorflow/core/debug/debug_io_utils.h
@@ -341,7 +341,7 @@ class DebugGrpcChannel {
   string url_;
   ::grpc::ClientContext ctx_;
   std::shared_ptr<::grpc::Channel> channel_;
-  std::unique_ptr<grpc::EventListener::Stub> stub_;
+  std::unique_ptr<EventListener::Stub> stub_;
   std::unique_ptr<::grpc::ClientReaderWriterInterface<Event, EventReply>>
       reader_writer_;
 
diff --git a/tensorflow/core/distributed_runtime/rpc/eager/grpc_eager_service_impl.cc b/tensorflow/core/distributed_runtime/rpc/eager/grpc_eager_service_impl.cc
index b9bea2ea..4789d9f0 100644
--- a/tensorflow/core/distributed_runtime/rpc/eager/grpc_eager_service_impl.cc
+++ b/tensorflow/core/distributed_runtime/rpc/eager/grpc_eager_service_impl.cc
@@ -52,10 +52,10 @@ absl::Status GrpcEagerServiceImpl::CreateMasterContext(
 void GrpcEagerServiceImpl::HandleRPCsLoop() {
 #define ENQUEUE_REQUEST(method)                                            \
   do {                                                                     \
-    tsl::Call<GrpcEagerServiceImpl, grpc::EagerService::AsyncService,      \
+    tsl::Call<GrpcEagerServiceImpl, EagerService::AsyncService,      \
               method##Request, method##Response>::                         \
         EnqueueRequest(&service_, cq_.get(),                               \
-                       &grpc::EagerService::AsyncService::Request##method, \
+                       &EagerService::AsyncService::Request##method, \
                        &GrpcEagerServiceImpl::method##Handler, false);     \
   } while (0)
   ENQUEUE_REQUEST(CreateContext);
@@ -69,10 +69,10 @@ void GrpcEagerServiceImpl::HandleRPCsLoop() {
 
   // Request a StreamingEnqueue call.
   tsl::ServerBidirectionalStreamingCall<GrpcEagerServiceImpl,
-                                        grpc::EagerService::AsyncService,
+                                        EagerService::AsyncService,
                                         EnqueueRequest, EnqueueResponse>::
       EnqueueRequest(&service_, cq_.get(),
-                     &grpc::EagerService::AsyncService::RequestStreamingEnqueue,
+                     &EagerService::AsyncService::RequestStreamingEnqueue,
                      &GrpcEagerServiceImpl::StreamingEnqueueHandler);
 
   void* tag;  // Matches the operation started against this cq_.
diff --git a/tensorflow/core/distributed_runtime/rpc/eager/grpc_eager_service_impl.h b/tensorflow/core/distributed_runtime/rpc/eager/grpc_eager_service_impl.h
index 7acc2955..4a530b7a 100644
--- a/tensorflow/core/distributed_runtime/rpc/eager/grpc_eager_service_impl.h
+++ b/tensorflow/core/distributed_runtime/rpc/eager/grpc_eager_service_impl.h
@@ -38,12 +38,12 @@ class GrpcEagerServiceImpl : public tsl::AsyncServiceInterface {
  public:
   template <class RequestMessage, class ResponseMessage>
   using EagerCall =
-      tsl::Call<GrpcEagerServiceImpl, grpc::EagerService::AsyncService,
+      tsl::Call<GrpcEagerServiceImpl, EagerService::AsyncService,
                 RequestMessage, ResponseMessage>;
   template <class RequestMessage, class ResponseMessage>
   using StreamingCall =
       tsl::ServerBidirectionalStreamingCall<GrpcEagerServiceImpl,
-                                            grpc::EagerService::AsyncService,
+                                            EagerService::AsyncService,
                                             RequestMessage, ResponseMessage>;
 
   GrpcEagerServiceImpl(WorkerEnv* env, ::grpc::ServerBuilder* server_builder);
@@ -63,10 +63,10 @@ class GrpcEagerServiceImpl : public tsl::AsyncServiceInterface {
       call->SendResponse(                                                     \
           ToGrpcStatus(local_impl_.method(&call->request, &call->response))); \
     });                                                                       \
-    tsl::Call<GrpcEagerServiceImpl, grpc::EagerService::AsyncService,         \
+    tsl::Call<GrpcEagerServiceImpl, EagerService::AsyncService,         \
               method##Request, method##Response>::                            \
         EnqueueRequest(&service_, cq_.get(),                                  \
-                       &grpc::EagerService::AsyncService::Request##method,    \
+                       &EagerService::AsyncService::Request##method,    \
                        &GrpcEagerServiceImpl::method##Handler, false);        \
   }
   HANDLER(CreateContext);
@@ -83,10 +83,10 @@ class GrpcEagerServiceImpl : public tsl::AsyncServiceInterface {
       call->SendResponse(ToGrpcStatus(local_impl_.Enqueue(
           call_opts.get(), &call->request, &call->response)));
     });
-    tsl::Call<GrpcEagerServiceImpl, grpc::EagerService::AsyncService,
+    tsl::Call<GrpcEagerServiceImpl, EagerService::AsyncService,
               EnqueueRequest, EnqueueResponse>::
         EnqueueRequest(&service_, cq_.get(),
-                       &grpc::EagerService::AsyncService::RequestEnqueue,
+                       &EagerService::AsyncService::RequestEnqueue,
                        &GrpcEagerServiceImpl::EnqueueHandler,
                        /*supports_cancel=*/true);
   }
@@ -104,11 +104,11 @@ class GrpcEagerServiceImpl : public tsl::AsyncServiceInterface {
             call->SendResponse(ToGrpcStatus(s));
           });
     });
-    tsl::Call<GrpcEagerServiceImpl, grpc::EagerService::AsyncService,
+    tsl::Call<GrpcEagerServiceImpl, EagerService::AsyncService,
               RunComponentFunctionRequest, RunComponentFunctionResponse>::
         EnqueueRequest(
             &service_, cq_.get(),
-            &grpc::EagerService::AsyncService::RequestRunComponentFunction,
+            &EagerService::AsyncService::RequestRunComponentFunction,
             &GrpcEagerServiceImpl::RunComponentFunctionHandler,
             /*supports_cancel=*/true);
   }
@@ -163,7 +163,7 @@ class GrpcEagerServiceImpl : public tsl::AsyncServiceInterface {
   std::unique_ptr<::grpc::Alarm> shutdown_alarm_;
 
   std::unique_ptr<::grpc::ServerCompletionQueue> cq_;
-  grpc::EagerService::AsyncService service_;
+  EagerService::AsyncService service_;
 
   GrpcEagerServiceImpl(const GrpcEagerServiceImpl&) = delete;
   void operator=(const GrpcEagerServiceImpl&) = delete;
diff --git a/tensorflow/core/distributed_runtime/rpc/grpc_server_lib.h b/tensorflow/core/distributed_runtime/rpc/grpc_server_lib.h
index 431e4c44..385ba1c2 100644
--- a/tensorflow/core/distributed_runtime/rpc/grpc_server_lib.h
+++ b/tensorflow/core/distributed_runtime/rpc/grpc_server_lib.h
@@ -231,7 +231,7 @@ class GrpcServer : public ServerInterface {
   std::unique_ptr<Thread> coordination_thread_ TF_GUARDED_BY(mu_);
 
   // TensorFlow profiler service implementation.
-  std::unique_ptr<grpc::ProfilerService::Service> profiler_service_ = nullptr;
+  std::unique_ptr<ProfilerService::Service> profiler_service_ = nullptr;
 
   // The overall server configuration.
   ServerDef server_def_ TF_GUARDED_BY(mu_);
diff --git a/tensorflow/core/profiler/rpc/profiler_service_impl.h b/tensorflow/core/profiler/rpc/profiler_service_impl.h
index e67e7d8a..38d0c0f9 100644
--- a/tensorflow/core/profiler/rpc/profiler_service_impl.h
+++ b/tensorflow/core/profiler/rpc/profiler_service_impl.h
@@ -30,7 +30,7 @@ namespace tensorflow {
 namespace profiler {
 
 ABSL_DEPRECATE_AND_INLINE()
-inline std::unique_ptr<tensorflow::grpc::ProfilerService::Service>
+inline std::unique_ptr<tensorflow::ProfilerService::Service>
 CreateProfilerService() {
   return tsl::profiler::CreateProfilerService();
 }
diff --git a/tensorflow/distribute/experimental/rpc/kernels/rpc_ops.cc b/tensorflow/distribute/experimental/rpc/kernels/rpc_ops.cc
index 15b466ce..7d33ad9b 100644
--- a/tensorflow/distribute/experimental/rpc/kernels/rpc_ops.cc
+++ b/tensorflow/distribute/experimental/rpc/kernels/rpc_ops.cc
@@ -237,7 +237,7 @@ class FunctionRegistry {
       TF_GUARDED_BY(mu_);
 };
 
-class RpcServiceImpl : public grpc::RpcService::Service {
+class RpcServiceImpl : public RpcService::Service {
  public:
   explicit RpcServiceImpl(const FunctionRegistry& registry)
       : registry_(registry) {}
diff --git a/tensorflow/workspace0.bzl b/tensorflow/workspace0.bzl
index ba00c859..fa79067e 100644
--- a/tensorflow/workspace0.bzl
+++ b/tensorflow/workspace0.bzl
@@ -22,11 +22,11 @@ def _tf_bind():
     # Needed by Protobuf
     native.bind(
         name = "grpc_cpp_plugin",
-        actual = "@com_github_grpc_grpc//src/compiler:grpc_cpp_plugin",
+        actual = "@com_github_grpc_grpc//:grpc_cpp_plugin",
     )
     native.bind(
         name = "grpc_python_plugin",
-        actual = "@com_github_grpc_grpc//src/compiler:grpc_python_plugin",
+        actual = "@com_github_grpc_grpc//:grpc_python_plugin",
     )
 
     native.bind(
diff --git a/third_party/systemlibs/grpc.bazel.cc_grpc_library.bzl b/third_party/systemlibs/grpc.bazel.cc_grpc_library.bzl
index 86d95b62..c891e999 100644
--- a/third_party/systemlibs/grpc.bazel.cc_grpc_library.bzl
+++ b/third_party/systemlibs/grpc.bazel.cc_grpc_library.bzl
@@ -88,7 +88,7 @@ def cc_grpc_library(
         generate_cc(
             name = codegen_grpc_target,
             srcs = proto_targets,
-            plugin = "@com_github_grpc_grpc//src/compiler:grpc_cpp_plugin",
+            plugin = "//external:grpc_cpp_plugin",
             well_known_protos = well_known_protos,
             generate_mocks = generate_mocks,
             **kwargs
@@ -100,6 +100,6 @@ def cc_grpc_library(
             hdrs = [":" + codegen_grpc_target],
             deps = deps +
                    extra_deps +
-                   ["@com_github_grpc_grpc//:grpc++_codegen_proto"],
+                   ["//external:grpc_lib"],
             **kwargs
         )
diff --git a/third_party/xla/xla/tsl/distributed_runtime/rpc/coordination/grpc_coordination_service_impl.cc b/third_party/xla/xla/tsl/distributed_runtime/rpc/coordination/grpc_coordination_service_impl.cc
index da888614..7354d64e 100644
--- a/third_party/xla/xla/tsl/distributed_runtime/rpc/coordination/grpc_coordination_service_impl.cc
+++ b/third_party/xla/xla/tsl/distributed_runtime/rpc/coordination/grpc_coordination_service_impl.cc
@@ -35,10 +35,10 @@ void GrpcCoordinationServiceImpl::HandleRPCsLoop() {
       continue;                                                               \
     }                                                                         \
     Call<GrpcCoordinationServiceImpl,                                         \
-         tensorflow::grpc::CoordinationService::AsyncService,                 \
+         tensorflow::CoordinationService::AsyncService,                 \
          tensorflow::method##Request, tensorflow::method##Response>::         \
         EnqueueRequest(&service_, cq_.get(),                                  \
-                       &tensorflow::grpc::CoordinationService::AsyncService:: \
+                       &tensorflow::CoordinationService::AsyncService:: \
                            Request##method,                                   \
                        &GrpcCoordinationServiceImpl::method##Handler, false); \
   } while (0)
diff --git a/third_party/xla/xla/tsl/distributed_runtime/rpc/coordination/grpc_coordination_service_impl.h b/third_party/xla/xla/tsl/distributed_runtime/rpc/coordination/grpc_coordination_service_impl.h
index 8f02cac6..5f6b5ac0 100644
--- a/third_party/xla/xla/tsl/distributed_runtime/rpc/coordination/grpc_coordination_service_impl.h
+++ b/third_party/xla/xla/tsl/distributed_runtime/rpc/coordination/grpc_coordination_service_impl.h
@@ -40,7 +40,7 @@ class GrpcCoordinationServiceImpl : public AsyncServiceInterface {
  public:
   template <class RequestMessage, class ResponseMessage>
   using CoordCall = Call<GrpcCoordinationServiceImpl,
-                         tensorflow::grpc::CoordinationService::AsyncService,
+                         tensorflow::CoordinationService::AsyncService,
                          RequestMessage, ResponseMessage>;
 
   GrpcCoordinationServiceImpl(thread::ThreadPool* compute_pool,
@@ -75,10 +75,10 @@ class GrpcCoordinationServiceImpl : public AsyncServiceInterface {
                                  });                                          \
     });                                                                       \
     Call<GrpcCoordinationServiceImpl,                                         \
-         tensorflow::grpc::CoordinationService::AsyncService,                 \
+         tensorflow::CoordinationService::AsyncService,                 \
          tensorflow::method##Request, tensorflow::method##Response>::         \
         EnqueueRequest(&service_, cq_.get(),                                  \
-                       &tensorflow::grpc::CoordinationService::AsyncService:: \
+                       &tensorflow::CoordinationService::AsyncService:: \
                            Request##method,                                   \
                        &GrpcCoordinationServiceImpl::method##Handler,         \
                        /*supports_cancel=*/false);                            \
@@ -111,7 +111,7 @@ class GrpcCoordinationServiceImpl : public AsyncServiceInterface {
   std::unique_ptr<::grpc::Alarm> shutdown_alarm_;
 
   std::unique_ptr<::grpc::ServerCompletionQueue> cq_;
-  tensorflow::grpc::CoordinationService::AsyncService service_;
+  tensorflow::CoordinationService::AsyncService service_;
 
   GrpcCoordinationServiceImpl(const GrpcCoordinationServiceImpl&) = delete;
   void operator=(const GrpcCoordinationServiceImpl&) = delete;
diff --git a/third_party/xla/xla/tsl/profiler/rpc/client/profiler_client.cc b/third_party/xla/xla/tsl/profiler/rpc/client/profiler_client.cc
index e4fa849f..85b55160 100644
--- a/third_party/xla/xla/tsl/profiler/rpc/client/profiler_client.cc
+++ b/third_party/xla/xla/tsl/profiler/rpc/client/profiler_client.cc
@@ -65,8 +65,8 @@ absl::Status ProfileGrpc(const std::string& service_address,
                          const ProfileRequest& request,
                          ProfileResponse* response) {
   ::grpc::ClientContext context;
-  std::unique_ptr<tensorflow::grpc::ProfilerService::Stub> stub =
-      CreateStub<tensorflow::grpc::ProfilerService>(service_address);
+  std::unique_ptr<tensorflow::ProfilerService::Stub> stub =
+      CreateStub<tensorflow::ProfilerService>(service_address);
   TF_RETURN_IF_ERROR(
       FromGrpcStatus(stub->Profile(&context, request, response)));
   return absl::OkStatus();
@@ -76,8 +76,8 @@ absl::Status NewSessionGrpc(const std::string& service_address,
                             const NewProfileSessionRequest& request,
                             NewProfileSessionResponse* response) {
   ::grpc::ClientContext context;
-  std::unique_ptr<tensorflow::grpc::ProfileAnalysis::Stub> stub =
-      CreateStub<tensorflow::grpc::ProfileAnalysis>(service_address);
+  std::unique_ptr<tensorflow::ProfileAnalysis::Stub> stub =
+      CreateStub<tensorflow::ProfileAnalysis>(service_address);
   TF_RETURN_IF_ERROR(
       FromGrpcStatus(stub->NewSession(&context, request, response)));
   return absl::OkStatus();
@@ -87,8 +87,8 @@ absl::Status MonitorGrpc(const std::string& service_address,
                          const MonitorRequest& request,
                          MonitorResponse* response) {
   ::grpc::ClientContext context;
-  std::unique_ptr<tensorflow::grpc::ProfilerService::Stub> stub =
-      CreateStub<tensorflow::grpc::ProfilerService>(service_address);
+  std::unique_ptr<tensorflow::ProfilerService::Stub> stub =
+      CreateStub<tensorflow::ProfilerService>(service_address);
   TF_RETURN_IF_ERROR(
       FromGrpcStatus(stub->Monitor(&context, request, response)));
   return absl::OkStatus();
@@ -108,7 +108,7 @@ RemoteProfilerSession::RemoteProfilerSession(
     const ProfileRequest& profile_request)
     : response_(absl::make_unique<ProfileResponse>()),
       service_address_(service_address),
-      stub_(CreateStub<tensorflow::grpc::ProfilerService>(service_address_)),
+      stub_(CreateStub<tensorflow::ProfilerService>(service_address_)),
       deadline_(deadline),
       profile_request_(profile_request) {
   response_->set_empty_trace(true);
diff --git a/third_party/xla/xla/tsl/profiler/rpc/client/profiler_client.h b/third_party/xla/xla/tsl/profiler/rpc/client/profiler_client.h
index 37bf7fdd..b4f633dd 100644
--- a/third_party/xla/xla/tsl/profiler/rpc/client/profiler_client.h
+++ b/third_party/xla/xla/tsl/profiler/rpc/client/profiler_client.h
@@ -82,7 +82,7 @@ class RemoteProfilerSession {
   std::unique_ptr<tensorflow::ProfileResponse> response_;
   // Client address and connection attributes.
   std::string service_address_;
-  std::unique_ptr<tensorflow::grpc::ProfilerService::Stub> stub_;
+  std::unique_ptr<tensorflow::ProfilerService::Stub> stub_;
   absl::Time deadline_;
   ::grpc::ClientContext grpc_context_;
   std::unique_ptr<
diff --git a/third_party/xla/xla/tsl/profiler/rpc/profiler_server.h b/third_party/xla/xla/tsl/profiler/rpc/profiler_server.h
index 8021de58..d4c6eb74 100644
--- a/third_party/xla/xla/tsl/profiler/rpc/profiler_server.h
+++ b/third_party/xla/xla/tsl/profiler/rpc/profiler_server.h
@@ -31,7 +31,7 @@ class ProfilerServer {
   void StartProfilerServer(int32_t port);
 
  private:
-  std::unique_ptr<tensorflow::grpc::ProfilerService::Service> service_;
+  std::unique_ptr<tensorflow::ProfilerService::Service> service_;
   std::unique_ptr<::grpc::Server> server_;
 };
 
diff --git a/third_party/xla/xla/tsl/profiler/rpc/profiler_service_impl.cc b/third_party/xla/xla/tsl/profiler/rpc/profiler_service_impl.cc
index f4b05540..d2028b5f 100644
--- a/third_party/xla/xla/tsl/profiler/rpc/profiler_service_impl.cc
+++ b/third_party/xla/xla/tsl/profiler/rpc/profiler_service_impl.cc
@@ -64,7 +64,7 @@ absl::Status CollectDataToRepository(const ProfileRequest& request,
                     request.host_name(), xspace);
 }
 
-class ProfilerServiceImpl : public tensorflow::grpc::ProfilerService::Service {
+class ProfilerServiceImpl : public tensorflow::ProfilerService::Service {
  public:
   ::grpc::Status Monitor(::grpc::ServerContext* ctx, const MonitorRequest* req,
                          MonitorResponse* response) override {
@@ -128,7 +128,7 @@ class ProfilerServiceImpl : public tensorflow::grpc::ProfilerService::Service {
 
 }  // namespace
 
-std::unique_ptr<tensorflow::grpc::ProfilerService::Service>
+std::unique_ptr<tensorflow::ProfilerService::Service>
 CreateProfilerService() {
   return std::make_unique<ProfilerServiceImpl>();
 }
diff --git a/third_party/xla/xla/tsl/profiler/rpc/profiler_service_impl.h b/third_party/xla/xla/tsl/profiler/rpc/profiler_service_impl.h
index b0c2c795..483ac1c8 100644
--- a/third_party/xla/xla/tsl/profiler/rpc/profiler_service_impl.h
+++ b/third_party/xla/xla/tsl/profiler/rpc/profiler_service_impl.h
@@ -22,7 +22,7 @@ limitations under the License.
 namespace tsl {
 namespace profiler {
 
-std::unique_ptr<tensorflow::grpc::ProfilerService::Service>
+std::unique_ptr<tensorflow::ProfilerService::Service>
 CreateProfilerService();
 
 }  // namespace profiler
-- 
2.45.2

