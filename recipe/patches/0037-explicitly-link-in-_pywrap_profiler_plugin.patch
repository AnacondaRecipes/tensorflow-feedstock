From 8b1a98ef60d74dccb80bd9b1af37976844a24ea9 Mon Sep 17 00:00:00 2001
From: Eric Lundby <Eric.Lundby@gmail.com>
Date: Fri, 3 Oct 2025 11:04:20 -0600
Subject: [PATCH 1/1] explicitly link in _pywrap_profiler_plugin

Fix profiler platform compatibility by moving all dependencies from macOS-only to global

The _pywrap_profiler_plugin was failing to load on Linux-aarch64 with undefined
symbol errors due to lazy binding. Several core TensorFlow libraries required
by the profiler plugin were incorrectly scoped to macOS-only dependencies.

Fixes undefined symbols for:
- tensorflow::ParseTensorName (framework_internal_impl)
- tensorflow::core::Arena::GetMemoryFallback (arena)
- tsl::histogram::Histogram::Histogram() (histogram)
- tsl::monitoring::Buckets::Exponential() (monitoring components)
- tsl::io::RecordWriter::Flush() (record_writer)
- tensorflow::strings::OrderedCode::ReadSignedNumIncreasing (ordered_code)
- tensorflow::GpuIdManager::TfToPlatformDeviceId (gpu_id_impl)
- profiler_factory_impl and profiler_session_impl

The profiler plugin depends on these components through its dependency chain:
profiler → xplane_to_tools_data → cost_utils → grappler → framework_internal_impl

Fixes: undefined symbol errors in _pywrap_profiler_plugin.so

---
 tensorflow/python/profiler/internal/BUILD | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/tensorflow/python/profiler/internal/BUILD b/tensorflow/python/profiler/internal/BUILD
index c59ed82222c..882a6bac05d 100644
--- a/tensorflow/python/profiler/internal/BUILD
+++ b/tensorflow/python/profiler/internal/BUILD
@@ -250,7 +250,6 @@ tsl_pybind_extension(
         "@local_xla//xla/tsl/protobuf:rpc_options_proto_cc_impl",
         "@local_xla//xla/tsl/protobuf:test_log_proto_cc_impl",
         "@pybind11",
-    ] + if_macos([
         "@local_xla//xla/tsl/lib/histogram",
         "@local_xla//xla/tsl/lib/io:record_writer",
         "@local_xla//xla/tsl/lib/monitoring:collection_registry",
@@ -264,5 +263,5 @@ tsl_pybind_extension(
         "@local_xla//xla/tsl/platform:resource",
         "@local_tsl//tsl/profiler/lib:profiler_factory_impl",
         "@local_tsl//tsl/profiler/lib:profiler_session_impl",
-    ]),
+    ],
 )
-- 
2.45.2

