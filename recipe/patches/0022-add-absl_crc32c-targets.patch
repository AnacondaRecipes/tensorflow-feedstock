From 881bb1ab25a535def9ce5c8b33de4fce1bd98b84 Mon Sep 17 00:00:00 2001
From: Eric Lundby <Eric.Lundby@gmail.com>
Date: Mon, 20 Oct 2025 12:46:36 -0600
Subject: [PATCH 1/1] 22

---
 .../third_party/absl/system.absl.base.BUILD   | 109 ++++--------------
 .../third_party/absl/system.absl.crc.BUILD    |  33 ++++++
 .../third_party/absl/system.absl.flags.BUILD  |   1 -
 .../absl/system.absl.functional.BUILD         |   5 +
 .../third_party/absl/system.absl.log.BUILD    |  71 ++++++++++++
 .../absl/system.absl.utility.BUILD            |   7 +-
 .../xla/third_party/absl/workspace.bzl        |  31 +++++
 7 files changed, 168 insertions(+), 89 deletions(-)
 create mode 100644 third_party/xla/third_party/absl/system.absl.crc.BUILD
 create mode 100644 third_party/xla/third_party/absl/system.absl.log.BUILD

diff --git a/third_party/xla/third_party/absl/system.absl.base.BUILD b/third_party/xla/third_party/absl/system.absl.base.BUILD
index d6bf8748dee..608a01846ac 100644
--- a/third_party/xla/third_party/absl/system.absl.base.BUILD
+++ b/third_party/xla/third_party/absl/system.absl.base.BUILD
@@ -4,6 +4,11 @@ package(default_visibility = ["//visibility:public"])
 
 [cc_library(
     name = n,
+    copts = [
+        "-Dabsl_nonnull=",
+        "-Dabsl_nullable=",
+        "-Dabsl_nullability_unknown=",
+    ],
 ) for n in [
     "config",
     "core_headers",
@@ -13,95 +18,25 @@ package(default_visibility = ["//visibility:public"])
     "errno_saver",
     "fast_type_id",
     "pretty_function",
+    "no_destructor",
+    "log_severity",
+    "raw_logging_internal",
+    "spinlock_wait",
+    "malloc_internal",
+    "base",
+    "prefetch",
+    "throw_delegate",
+    "endian",
+    "exponential_biased",
+    "periodic_sampler",
+    "strerror",
 ]]
 
 cc_library(
-    name = "log_severity",
-    linkopts = ["-labsl_log_severity"],
-)
-
-cc_library(
-    name = "raw_logging_internal",
-    linkopts = ["-labsl_raw_logging_internal"],
-    visibility = [
-        "//absl:__subpackages__",
-    ],
-    deps = [
-        ":log_severity",
-    ],
-)
-
-cc_library(
-    name = "spinlock_wait",
-    linkopts = ["-labsl_spinlock_wait"],
-    visibility = [
-        "//absl/base:__pkg__",
-    ],
-)
-
-cc_library(
-    name = "malloc_internal",
-    linkopts = [
-        "-labsl_malloc_internal",
-        "-pthread",
-    ],
-    deps = [
-        ":base",
-        ":raw_logging_internal",
-    ],
-)
-
-cc_library(
-    name = "base",
-    linkopts = [
-        "-labsl_base",
-        "-pthread",
-    ],
-    deps = [
-        ":log_severity",
-        ":raw_logging_internal",
-        ":spinlock_wait",
-    ],
-)
-
-cc_library(
-    name = "throw_delegate",
-    linkopts = ["-labsl_throw_delegate"],
-    visibility = [
-        "//absl:__subpackages__",
-    ],
-    deps = [
-        ":raw_logging_internal",
-    ],
-)
-
-cc_library(
-    name = "endian",
-    deps = [
-        ":base",
-    ],
-)
-
-cc_library(
-    name = "exponential_biased",
-    linkopts = ["-labsl_exponential_biased"],
-    visibility = [
-        "//absl:__subpackages__",
-    ],
-)
-
-cc_library(
-    name = "periodic_sampler",
-    linkopts = ["-labsl_periodic_sampler"],
-    deps = [
-        ":exponential_biased",
-    ],
-)
-
-cc_library(
-    name = "strerror",
-    linkopts = ["-labsl_strerror"],
-    visibility = [
-        "//absl:__subpackages__",
+    name = "nullability",
+    defines = [
+        "absl_nonnull=",
+        "absl_nullable=", 
+        "absl_nullability_unknown=",
     ],
 )
diff --git a/third_party/xla/third_party/absl/system.absl.crc.BUILD b/third_party/xla/third_party/absl/system.absl.crc.BUILD
new file mode 100644
index 00000000000..21ac1cf81ea
--- /dev/null
+++ b/third_party/xla/third_party/absl/system.absl.crc.BUILD
@@ -0,0 +1,33 @@
+load("@rules_cc//cc:defs.bzl", "cc_library")
+
+package(default_visibility = ["//visibility:public"])
+
+licenses(["notice"])  # Apache
+
+cc_library(
+    name = "crc",
+    linkopts = ["-labsl_crc"],
+    deps = [
+        "//absl/base:raw_logging_internal",
+    ],
+)
+
+cc_library(
+    name = "crc32c",
+    linkopts = ["-labsl_crc32c"],
+)
+
+cc_library(
+    name = "crc_cord_state",
+    linkopts = ["-labsl_crc_cord_state"],
+)
+
+cc_library(
+    name = "crc_internal",
+    linkopts = ["-labsl_crc_internal"],
+)
+
+cc_library(
+    name = "non_temporal_memcpy",
+    linkopts = ["-labsl_base"],
+)
\ No newline at end of file
diff --git a/third_party/xla/third_party/absl/system.absl.flags.BUILD b/third_party/xla/third_party/absl/system.absl.flags.BUILD
index aff653c7e5b..44020d5bfcb 100644
--- a/third_party/xla/third_party/absl/system.absl.flags.BUILD
+++ b/third_party/xla/third_party/absl/system.absl.flags.BUILD
@@ -97,7 +97,6 @@ cc_library(
 
 cc_library(
     name = "flag",
-    linkopts = ["-labsl_flags"],
     deps = [
         ":config",
         ":flag_internal",
diff --git a/third_party/xla/third_party/absl/system.absl.functional.BUILD b/third_party/xla/third_party/absl/system.absl.functional.BUILD
index 9439bd0ba22..a12a44668d1 100644
--- a/third_party/xla/third_party/absl/system.absl.functional.BUILD
+++ b/third_party/xla/third_party/absl/system.absl.functional.BUILD
@@ -13,3 +13,8 @@ cc_library(
 cc_library(
     name = "function_ref",
 )
+
+cc_library(
+    name = "overload",
+    linkopts = ["-labsl_base"],
+)
\ No newline at end of file
diff --git a/third_party/xla/third_party/absl/system.absl.log.BUILD b/third_party/xla/third_party/absl/system.absl.log.BUILD
new file mode 100644
index 00000000000..3cc52453752
--- /dev/null
+++ b/third_party/xla/third_party/absl/system.absl.log.BUILD
@@ -0,0 +1,71 @@
+load("@rules_cc//cc:defs.bzl", "cc_library")
+
+package(default_visibility = ["//visibility:public"])
+
+licenses(["notice"])  # Apache
+
+cc_library(
+    name = "absl_log",
+    linkopts = [
+        "-labsl_vlog_config_internal",
+        "-labsl_log_internal_conditions",
+        "-labsl_log_internal_check_op",
+        "-labsl_log_internal_message",
+        "-labsl_log_internal_nullguard",
+    ],
+)
+
+cc_library(
+    name = "absl_check",
+    linkopts = [
+        "-labsl_vlog_config_internal",
+        "-labsl_log_internal_check_op",
+        "-labsl_log_internal_message",
+        "-labsl_log_internal_nullguard",
+    ],
+)
+
+alias(
+    name = "log",
+    actual = ":absl_log",
+)
+
+alias(
+    name = "check",
+    actual = ":absl_check",
+)
+
+cc_library(
+    name = "die_if_null",
+    linkopts = ["-labsl_die_if_null"],
+)
+
+cc_library(
+    name = "log_entry",
+    linkopts = ["-labsl_log_internal_message"],
+)
+
+cc_library(
+    name = "log_sink",
+    linkopts = ["-labsl_log_sink"],
+)
+
+cc_library(
+    name = "log_sink_registry",
+    linkopts = ["-labsl_log_sink"],
+)
+
+cc_library(
+    name = "globals",
+    linkopts = ["-labsl_log_globals"],
+)
+
+cc_library(
+    name = "log_flags",
+    linkopts = ["-labsl_log_flags"],
+)
+
+cc_library(
+    name = "initialize",
+    linkopts = ["-labsl_log_initialize"],
+)
\ No newline at end of file
diff --git a/third_party/xla/third_party/absl/system.absl.utility.BUILD b/third_party/xla/third_party/absl/system.absl.utility.BUILD
index e15049e261c..e9c25fe3714 100644
--- a/third_party/xla/third_party/absl/system.absl.utility.BUILD
+++ b/third_party/xla/third_party/absl/system.absl.utility.BUILD
@@ -1,6 +1,11 @@
 load("@rules_cc//cc:defs.bzl", "cc_library")
 
+package(default_visibility = ["//visibility:public"])
+
 cc_library(
     name = "utility",
-    visibility = ["//visibility:public"],
 )
+
+cc_library(
+    name = "if_constexpr",
+)
\ No newline at end of file
diff --git a/third_party/xla/third_party/absl/workspace.bzl b/third_party/xla/third_party/absl/workspace.bzl
index 9144c5bd5b6..e24a2b08b9c 100644
--- a/third_party/xla/third_party/absl/workspace.bzl
+++ b/third_party/xla/third_party/absl/workspace.bzl
@@ -11,9 +11,40 @@ def repo():
     ABSL_SHA256 = "c397cd9cca3f71724a8ddf183e7fa71c19196eaafd1dc2a3c86d3a572613a807"
     # LINT.ThenChange(//tensorflow/lite/tools/cmake/modules/abseil-cpp.cmake)
 
+    SYS_DIRS = [
+        "algorithm",
+        "base",
+        "crc",
+        "log",
+        "cleanup",
+        "container",
+        "debugging",
+        "flags",
+        "functional",
+        "hash",
+        "memory",
+        "meta",
+        "numeric",
+        "random",
+        "status",
+        "strings",
+        "synchronization",
+        "time",
+        "types",
+        "utility",
+    ]
+
+    SYS_LINKS = {
+        "//third_party/absl:system.absl.{name}.BUILD".format(name = n): "absl/{name}/BUILD.bazel".format(name = n)
+        for n in SYS_DIRS
+    }
+
     tf_http_archive(
         name = "com_google_absl",
         sha256 = ABSL_SHA256,
+        build_file = "//third_party/absl:com_google_absl.BUILD",
+        system_build_file = "//third_party/absl:system.BUILD",
+        system_link_files = SYS_LINKS,
         strip_prefix = "abseil-cpp-{commit}".format(commit = ABSL_COMMIT),
         urls = tf_mirror_urls("https://github.com/abseil/abseil-cpp/archive/{commit}.tar.gz".format(commit = ABSL_COMMIT)),
         patch_file = [
-- 
2.45.2

