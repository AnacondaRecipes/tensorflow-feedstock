From c4c9aca08ca8a3fd89600c4b05812cbeee82bc6a Mon Sep 17 00:00:00 2001
From: Patryk Kups <pkups@anaconda.com>
Date: Wed, 28 Jan 2026 10:17:34 +0100
Subject: [PATCH] patch

---
 tensorflow/core/common_runtime/eager/BUILD    |  2 +-
 tensorflow/core/distributed_runtime/BUILD     |  2 +-
 .../integration_test/BUILD                    |  4 +-
 tensorflow/core/distributed_runtime/rpc/BUILD |  2 +-
 third_party/xla/xla/pjrt/distributed/BUILD    |  2 +-
 third_party/xla/xla/pjrt/gpu/BUILD            |  2 +-
 third_party/xla/xla/service/BUILD             |  2 +-
 .../distributed_runtime/coordination/BUILD    | 42 ++++++++++++++++++-
 .../tsl/distributed_runtime/preemption/BUILD  |  2 +-
 .../rpc/coordination/BUILD                    |  2 +-
 10 files changed, 51 insertions(+), 11 deletions(-)

diff --git a/tensorflow/core/common_runtime/eager/BUILD b/tensorflow/core/common_runtime/eager/BUILD
index 46d6d0ab..693ae36b 100644
--- a/tensorflow/core/common_runtime/eager/BUILD
+++ b/tensorflow/core/common_runtime/eager/BUILD
@@ -252,7 +252,7 @@ tf_cuda_library(
             "@com_google_absl//absl/time",
             "@local_tsl//tsl/platform:mutex",
             "@local_xla//xla/pjrt/gpu:se_gpu_pjrt_client",
-            "@local_xla//xla/tsl/distributed_runtime/coordination:coordination_service",
+            "@local_xla//xla/tsl/distributed_runtime/coordination:coordination_service_hdrs_only",
             "@local_xla//xla/tsl/distributed_runtime/coordination:coordination_service_agent",
             "@local_xla//xla/tsl/distributed_runtime/preemption:preemption_notifier",
             "@local_xla//xla/tsl/platform:statusor",
diff --git a/tensorflow/core/distributed_runtime/BUILD b/tensorflow/core/distributed_runtime/BUILD
index 6c6910aa..ff79c99a 100644
--- a/tensorflow/core/distributed_runtime/BUILD
+++ b/tensorflow/core/distributed_runtime/BUILD
@@ -174,7 +174,7 @@ cc_library(
         "//tensorflow/core/activity_watcher",
         "//tensorflow/core/protobuf:worker_proto_cc",
         "@com_google_absl//absl/log",
-        "@local_xla//xla/tsl/distributed_runtime/coordination:coordination_service",
+        "@local_xla//xla/tsl/distributed_runtime/coordination:coordination_service_hdrs_only",
         "@local_xla//xla/tsl/distributed_runtime/coordination:coordination_service_agent",
         "@local_xla//xla/tsl/distributed_runtime/coordination:coordination_service_rpc_handler",
         "@local_xla//xla/tsl/protobuf:coordination_service_proto_cc",
diff --git a/tensorflow/core/distributed_runtime/integration_test/BUILD b/tensorflow/core/distributed_runtime/integration_test/BUILD
index 50cf7670..3cffa9e5 100644
--- a/tensorflow/core/distributed_runtime/integration_test/BUILD
+++ b/tensorflow/core/distributed_runtime/integration_test/BUILD
@@ -108,7 +108,7 @@ tf_cuda_cc_test(
         "//tensorflow/core/common_runtime/eager:context",
         "//tensorflow/core/distributed_runtime:server_lib",
         "//tensorflow/core/platform:env",
-        "@local_xla//xla/tsl/distributed_runtime/coordination:coordination_service",
+        "@local_xla//xla/tsl/distributed_runtime/coordination:coordination_service_hdrs_only",
         "@local_xla//xla/tsl/distributed_runtime/coordination:coordination_service_agent",
     ],
 )
@@ -142,7 +142,7 @@ tf_cc_test(
         "//tensorflow/core/distributed_runtime:server_lib",
         "//tensorflow/core/platform:env",
         "@com_google_absl//absl/synchronization",
-        "@local_xla//xla/tsl/distributed_runtime/coordination:coordination_service",
+        "@local_xla//xla/tsl/distributed_runtime/coordination:coordination_service_hdrs_only",
         "@local_xla//xla/tsl/distributed_runtime/coordination:coordination_service_agent",
     ],
 )
diff --git a/tensorflow/core/distributed_runtime/rpc/BUILD b/tensorflow/core/distributed_runtime/rpc/BUILD
index c0351bbe..cb454aa3 100644
--- a/tensorflow/core/distributed_runtime/rpc/BUILD
+++ b/tensorflow/core/distributed_runtime/rpc/BUILD
@@ -335,7 +335,7 @@ cc_library(
         "//tensorflow/core/nccl:collective_communicator",
         "//tensorflow/core/profiler/rpc:profiler_service_impl",
         "@com_google_absl//absl/strings",
-        "@local_xla//xla/tsl/distributed_runtime/coordination:coordination_service",
+        "@local_xla//xla/tsl/distributed_runtime/coordination:coordination_service_hdrs_only",
         "@local_xla//xla/tsl/distributed_runtime/rpc:async_service_interface",
     ] + tf_protos_profiler_service() + tf_grpc_dependencies() + tf_grpc_cc_dependencies(),
     alwayslink = 1,
diff --git a/third_party/xla/xla/pjrt/distributed/BUILD b/third_party/xla/xla/pjrt/distributed/BUILD
index f88dcb45..287abcbb 100644
--- a/third_party/xla/xla/pjrt/distributed/BUILD
+++ b/third_party/xla/xla/pjrt/distributed/BUILD
@@ -25,7 +25,7 @@ cc_library(
         ":util",
         "//xla:types",
         "//xla:util",
-        "//xla/tsl/distributed_runtime/coordination:coordination_service",
+        "//xla/tsl/distributed_runtime/coordination:coordination_service_hdrs_only",
         "//xla/tsl/distributed_runtime/rpc:async_service_interface",
         "//xla/tsl/distributed_runtime/rpc/coordination:grpc_coordination_service_impl",
         "//xla/tsl/protobuf:coordination_config_proto_cc",
diff --git a/third_party/xla/xla/pjrt/gpu/BUILD b/third_party/xla/xla/pjrt/gpu/BUILD
index d590e52c..e5d47e96 100644
--- a/third_party/xla/xla/pjrt/gpu/BUILD
+++ b/third_party/xla/xla/pjrt/gpu/BUILD
@@ -120,7 +120,7 @@ cc_library(
         "//xla/stream_executor/integrations:tf_allocator_adapter",
         "//xla/tsl/concurrency:async_value",
         "//xla/tsl/concurrency:ref_count",
-        "//xla/tsl/distributed_runtime/coordination:coordination_service",
+        "//xla/tsl/distributed_runtime/coordination:coordination_service_hdrs_only",
         "//xla/tsl/distributed_runtime/coordination:coordination_service_agent",
         "//xla/tsl/framework:allocator",
         "//xla/tsl/framework:bfc_allocator",
diff --git a/third_party/xla/xla/service/BUILD b/third_party/xla/xla/service/BUILD
index ce859c54..d735e675 100644
--- a/third_party/xla/xla/service/BUILD
+++ b/third_party/xla/xla/service/BUILD
@@ -5279,7 +5279,7 @@ cc_library(
     hdrs = ["global_device_id.h"],
     deps = [
         "//xla/runtime:device_id",
-        "//xla/tsl/distributed_runtime/coordination:coordination_service",
+        "//xla/tsl/distributed_runtime/coordination:coordination_service_hdrs_only",
         "@com_google_absl//absl/strings",
         "@com_google_absl//absl/types:span",
     ],
diff --git a/third_party/xla/xla/tsl/distributed_runtime/coordination/BUILD b/third_party/xla/xla/tsl/distributed_runtime/coordination/BUILD
index 962640f0..73df6921 100644
--- a/third_party/xla/xla/tsl/distributed_runtime/coordination/BUILD
+++ b/third_party/xla/xla/tsl/distributed_runtime/coordination/BUILD
@@ -50,7 +50,7 @@ cc_library(
 )
 
 cc_library(
-    name = "coordination_service",
+    name = "coordination_service_impl",
     srcs = ["coordination_service.cc"],
     hdrs = ["coordination_service.h"],
     deps = [
@@ -84,6 +84,46 @@ cc_library(
     ],
 )
 
+cc_library(
+    name = "coordination_service",
+    deps = [":coordination_service_impl"],
+    visibility = ["//visibility:public"],
+)
+
+cc_library(
+    name = "coordination_service_hdrs_only",
+    hdrs = ["coordination_service.h"],
+    deps = [
+        ":coordination_client",
+        ":coordination_service_error_util",
+        ":key_value_store",
+        "//xla/tsl/distributed_runtime:call_options",
+        "//xla/tsl/lib/gtl:int_type",
+        "//xla/tsl/platform:env",
+        "//xla/tsl/platform:status",
+        "//xla/tsl/protobuf:coordination_config_proto_cc",
+        "//xla/tsl/protobuf:coordination_service_proto_cc",
+        "//xla/tsl/util:device_name_utils",
+        "@com_google_absl//absl/algorithm:container",
+        "@com_google_absl//absl/base:core_headers",
+        "@com_google_absl//absl/container:flat_hash_map",
+        "@com_google_absl//absl/container:flat_hash_set",
+        "@com_google_absl//absl/hash",
+        "@com_google_absl//absl/log",
+        "@com_google_absl//absl/log:check",
+        "@com_google_absl//absl/status",
+        "@com_google_absl//absl/status:statusor",
+        "@com_google_absl//absl/strings",
+        "@com_google_absl//absl/strings:str_format",
+        "@com_google_absl//absl/strings:string_view",
+        "@com_google_absl//absl/synchronization",
+        "@com_google_absl//absl/time",
+        "@com_google_absl//absl/types:span",
+        "@local_tsl//tsl/platform:random",
+    ],
+    visibility = ["//visibility:public"],
+)
+
 tf_proto_library(
     name = "test_device_proto",
     testonly = 1,
diff --git a/third_party/xla/xla/tsl/distributed_runtime/preemption/BUILD b/third_party/xla/xla/tsl/distributed_runtime/preemption/BUILD
index 6dd6bd76..bd2f5c47 100644
--- a/third_party/xla/xla/tsl/distributed_runtime/preemption/BUILD
+++ b/third_party/xla/xla/tsl/distributed_runtime/preemption/BUILD
@@ -78,7 +78,7 @@ tsl_cc_test(
         ":preemption_notifier",
         ":preemption_sync_manager",
         "//xla/tsl/distributed_runtime/coordination:coordination_client",
-        "//xla/tsl/distributed_runtime/coordination:coordination_service",
+        "//xla/tsl/distributed_runtime/coordination:coordination_service_hdrs_only",
         "//xla/tsl/distributed_runtime/coordination:coordination_service_agent",
         "//xla/tsl/distributed_runtime/rpc:async_service_interface",
         "//xla/tsl/distributed_runtime/rpc/coordination:grpc_coordination_client",
diff --git a/third_party/xla/xla/tsl/distributed_runtime/rpc/coordination/BUILD b/third_party/xla/xla/tsl/distributed_runtime/rpc/coordination/BUILD
index d1d1cbd1..c4155298 100644
--- a/third_party/xla/xla/tsl/distributed_runtime/rpc/coordination/BUILD
+++ b/third_party/xla/xla/tsl/distributed_runtime/rpc/coordination/BUILD
@@ -36,7 +36,7 @@ cc_library(
     srcs = ["grpc_coordination_service_impl.cc"],
     hdrs = ["grpc_coordination_service_impl.h"],
     deps = [
-        "//xla/tsl/distributed_runtime/coordination:coordination_service",
+        "//xla/tsl/distributed_runtime/coordination:coordination_service_hdrs_only",
         "//xla/tsl/distributed_runtime/coordination:coordination_service_agent",
         "//xla/tsl/distributed_runtime/coordination:coordination_service_rpc_handler",
         "//xla/tsl/distributed_runtime/rpc:async_service_interface",
-- 
2.39.5 (Apple Git-154)

